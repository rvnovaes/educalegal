include:
  - element-generate-file.yml
---
modules:
  - .element_educalegal_client
  - .element_sendgrid
---
event: el_send_email
code: |
  from_email = school_email
  to_emails = list()
  for recipient in recipients:
    to_emails.append(recipient["email"])
  subject = email_subject
  html_content = email_html_content
  category = email_category
  file_path = generated_file.pdf.path()
  file_name = mayan_file_name
  log("Enviando e-mail para {to_emails}".format(to_emails=to_emails))
  response_status_code, response_message = send_email_sendgrid(from_email, to_emails, subject, html_content, category, file_path, file_name)
  log("Sendgrid response status code: " + str(response_status_code))
  log("Sendgrid response message: " + response_message)
  if response_status_code == 202:
    cd_send_email = True
    cd_status = 'enviado por e-mail'
    el_document_patched_with_email_data = elc.patch_document_with_email_data(doc_uuid, cd_send_email, cd_status)
    email_success
  else:
    log(str(response_status_code) + " " + response_message)
    log(str(response_status_code) + " " + response_message, "console")
    email_failure
---
event: email_success
back button: False
question: Documento enviado por e-mail com sucesso
subquestion: |
  ####O documento foi enviado para o(s) seguinte(s) destinatário(s):
  % for recipient in to_emails:
    * ${ recipient }
    ---
  % endfor
  Você também pode baixar os documentos:
  [PDF](${ generated_file.pdf.url_for() })
  ou
  [DOCX](${ generated_file.docx.url_for() })
action buttons:
  code: |
    [el_button]
---
event: email_failure
question: Tentativa de enviar o documento por e-mail falhou
subquestion: |
  Entre em contato com o suporte e forneça as informações abaixo:

  Dados enviados para o servidor:
  ${ from_email }
  % for recipient in to_emails:
      * ${ recipient }
      ---
  % endfor
  ${ file_path}

  Dados retornados do servidor:
  ${ response_status_code }
  ${ response_message }

  Você também pode baixar os documentos:
  [PDF](${ generated_file.pdf.url_for() })
  ou
  [DOCX](${ generated_file.docx.url_for() })
---