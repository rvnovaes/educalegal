---
metadata:
  title: Enviar documento para assinatura eletrônica
---
sections:
  - Minuta
  - Parte
  - Contraparte
  - Parte extra
  - Anexos
  - Conclusão
---
include:
  - element-tenant-school-interview.yml
  - element-features.yml
  - element-roadmap.yml
  - element-data-list.yml
  - element-signature.yml
  - element-school-email-reviewed.yml
  - element-default-messages.yml
  - element-witness.yml
---
modules:
  - docassemble_wrappers.validator_collection_br
  - .module_docusign_client
  - .module_normalize_ascii
  - .module_educalegal_client
---
id: logic
mandatory: True
code: |
  if valid_data:
    menu_items
    if len(school_names_list) > 1:
      selected_school
    else:
      selected_school = school_names_list[0]
    if has_witnesses:
      teeste
    interview_document_type_choice
    part_types.target_number = 1
    for item in part_types:
      item.name.text
    if school_party_type == part_types[0].name.text:
      parts.target_number = 1
      parts[0].person_type = "organization"
      parts[0].name.text = school_legal_name
      parts[0].cnpj = school_cnpj
      parts[0].email = school_email
    elif school_party_type == part_types[0].counterpart_name:
      counterparts.target_number = 1
      counterparts[0].person_type = "organization"
      counterparts[0].name.text = school_legal_name
      counterparts[0].cnpj = school_cnpj
      counterparts[0].email = school_email
    elif school_party_type == part_types[0].extrapart_name:
      extraparts.target_number = 1
      extraparts[0].person_type = "organization"
      extraparts[0].name.text = school_legal_name
      extraparts[0].cnpj = school_cnpj
      extraparts[0].email = school_email
    reviewed_school_email_answer
    if not school_party_type == part_types[0].name.text:
      for item in parts:
        item.name.text
    elif not school_party_type == part_types[0].counterpart_name:
      for item in counterparts:
        item.name.text
    elif not school_party_type == part_types[0].extrapart_name:
      if part_types[0].has_extraparts:
        for item in extraparts:
          item.name.text
    has_attachment
    el_patch_document
    document_ready_screen
---
code: |
  # Tipo de documento escolhido pelo usuario
  interview_document_type = interview_document_type_choice
---
code: |
  custom_file_name = today(format = 'YYYYMMdd') + '-' + format_time(last_access_time(), format='hhmmss') + '-' + interview_custom_file_name_string + '.pdf'
---
code: |
  if signature_provider == 'DOCUSING':
    generated_file_signature = pdf_concatenate(generic_document, signature_page, filename=custom_file_name)
  else:
    generated_file_signature = pdf_concatenate(generic_document, filename=custom_file_name)
---
code: |
  if has_attachment:
    generated_file_attachment = pdf_concatenate(generated_file_signature, uploaded_file, filename=custom_file_name)
  else:
    generated_file_attachment = generated_file_signature
  generated_file = generated_file_attachment
---
attachment:
  variable name: signature_page
  docx template file: include-signature-page.docx
---
section: Minuta
progress: 5
question: |
  Insira a minuta que deseja enviar para assinatura eletrônica.
subquestion:  |
  ${ selected_school }
fields:
  - "Tipo do documento:": interview_document_type_choice
    datatype: dropdown
    code: |
      document_types_names_list
  - "Inserir minuta:": generic_document
    required: true
    datatype: files
---
objects:
  - part_types: DAList.using(object_type=Person, ask_number=True)
---
section: Parte
progress: 5
question: Parte
subquestion:  |
fields:
  - Número de Tipo de Pessoas: part_types.target_number
    required: true
    datatype: integer
    default: 1
    min: 1
---
progress: 5
section: Partes
question: Tipos de Partes
fields:
  - "Denominação da Parte:": part_types[i].name.text
    required: True
    help: "Ex: Contratante(s), Locador(es) "
  - "Denominação da Contraparte:": part_types[i].counterpart_name
    required: True
    help: "Ex: Contratada(s), Locatária(s)"
  - "Haverá parte extra (Ex: Fiador):": part_types[i].has_extraparts
    help: "Por exemplo, fiador"
    datatype: yesnoradio
  - "Denominação da Extra parte:": part_types[i].extrapart_name
    required: True
    default: "Fiador(es)"
    js show if: |
      val("part_types[i].has_extraparts")
---
code: |
  school_party_type_list = list()
  if part_types[0].has_extraparts:
    school_party_type_list.append(part_types[0].name.text)
    school_party_type_list.append(part_types[0].counterpart_name)
    school_party_type_list.append(part_types[0].extrapart_name)
  else:
    school_party_type_list.append(part_types[0].name.text)
    school_party_type_list.append(part_types[0].counterpart_name)
---
section: Escola
question: |
  Qual o tipo da parte é a escola?
fields:
  - "Tipo:": school_party_type
    required: True
    datatype: dropdown
    code: |
      school_party_type_list
---
objects:
  - parts: DAList.using(object_type=Person, ask_number=True)
---
section: Parte
progress: 10
question: Dados da outra parte
fields:
  - Número de Pessoas: parts.target_number
    required: true
    datatype: integer
    default: 1
    min: 1
---
section: Parte
progress: 20
question: |
  Dados do(a) ${word(ordinal(i)) } ${ part_types[0].name.text }
fields:
  - "Tipo:": parts[i].person_type
    datatype: radio
    choices:
      - Pessoa Física: individual
      - Pessoa Jurídica: organization
  - 'Nome/Razão social:': parts[i].name.text
    validate: validate_person_full_name
    help: 'Para pessoa jurídica informe o nome conforme consta no CNPJ. Para pessoa física, o nome completo.'
    js show if: |
      val("parts[i].person_type")
  - "E-mail:": parts[i].email
    datatype: email
    help: ${ help_email_msg }
    required: True
    js show if: |
       val("parts[i].person_type") != null
  - "CPF:": parts[i].cpf
    required: False
    validate: validate_cpf
    show if:
      variable: parts[i].person_type
      is: individual
  - "CNPJ:": parts[i].cnpj
    required: False
    validate: validate_cnpj
    show if:
      variable: parts[i].person_type
      is: organization
script: |
  <script type="text/javascript">
    $(document).ready(function(){
        $('#X2ZpZWxkXzM').mask('000.000.000-00', {reverse: true});
        $('#X2ZpZWxkXzQ').mask('00.000.000/0000-00', {reverse: true});
      });
  </script>
---
objects:
  - counterparts: DAList.using(object_type=Person, ask_number=True)
---
section: Contraparte
progress: 40
question: Dados da outra parte
fields:
  - Número de Pessoas: counterparts.target_number
    required: true
    datatype: integer
    default: 1
    min: 1
---
section: Contraparte
progress: 50
question: |
  Dados do(a) ${word(ordinal(i)) } ${ part_types[i].counterpart_name }
fields:
  - "Tipo:": counterparts[i].person_type
    datatype: radio
    choices:
      - Pessoa Física: individual
      - Pessoa Jurídica: organization
  - 'Nome/Razão social:': counterparts[i].name.text
    validate: validate_person_full_name
    help: 'Para pessoa jurídica informe o nome conforme consta no CNPJ. Para pessoa física, o nome completo.'
    js show if: |
      val("counterparts[i].person_type")
  - "E-mail:": counterparts[i].email
    datatype: email
    help: ${ help_email_msg }
    required: False
    js show if: |
       val("counterparts[i].person_type") != null
  - "CPF:": counterparts[i].cpf
    required: False
    validate: validate_cpf
    show if:
      variable: counterparts[i].person_type
      is: individual
  - "CNPJ:": counterparts[i].cnpj
    required: False
    validate: validate_cnpj
    show if:
      variable: counterparts[i].person_type
      is: organization
script: |
  <script type="text/javascript">
    $(document).ready(function(){
        $('#X2ZpZWxkXzM').mask('000.000.000-00', {reverse: true});
        $('#X2ZpZWxkXzQ').mask('00.000.000/0000-00', {reverse: true});
      });
  </script>
---
objects:
  - extraparts: DAList.using(object_type=Person, ask_number=True)
---
section: Parte Extra
progress: 70
question: Parte extra
fields:
  - Número de ${ part_types[i].extrapart_name }: extraparts.target_number
    required: true
    datatype: integer
    default: 1
    min: 1
---
section: Parte Extra
progress: 80
question: |
  Dados do(a) ${word(ordinal(i)) } ${ part_types[i].extrapart_name }
fields:
  - "Tipo:": extraparts[i].person_type
    datatype: radio
    choices:
      - Pessoa Física: individual
      - Pessoa Jurídica: organization
  - 'Nome/Razão social:': extraparts[i].name.text
    validate: validate_person_full_name
    help: 'Para pessoa jurídica informe o nome conforme consta no CNPJ. Para pessoa física, o nome completo.'
    js show if: |
      val("extraparts[i].person_type")
  - "E-mail:": extraparts[i].email
    datatype: email
    help: ${ help_email_msg }
    required: True
    js show if: |
       val("extraparts[i].person_type") != null
  - "CPF:": extraparts[i].cpf
    required: False
    validate: validate_cpf
    show if:
      variable: extraparts[i].person_type
      is: individual
  - "CNPJ:": extraparts[i].cnpj
    required: False
    validate: validate_cnpj
    show if:
      variable: extraparts[i].person_type
      is: organization
script: |
  <script type="text/javascript">
    $(document).ready(function(){
        $('#X2ZpZWxXzI').mask('000.000.000-00', {reverse: true});
        $('#X2ZpZWxkzM').mask('00.000.000/0000-00', {reverse: true});
      });
  </script>
---
section: Anexos
progress: 90
question: |
  Anexos:
  - Lista tipos de documentos: ${ document_types_names_list }

  - Opção escolhida: ${ interview_document_type_choice }

  - Id Tipo de Documento: ${ interview_document_type }

  - Nome do arquivo: ${ custom_file_name }
fields:
  - 'Deseja inserir algum arquivo anexo? :': has_attachment
    datatype: yesnoradio
  - 'Anexo (Formatos válidos: PDF) :': uploaded_file
    accept: |
      "application/pdf"
    datatype: files
    show if:
      variable: has_attachment
      is: True
---
code: |
  recipients = list()
  for item in parts:
      if item.email:
          new_recipient = dict()
          new_recipient['name'] = item.name.text
          new_recipient['email'] = item.email
          new_recipient['group'] = 'signers'
          new_recipient['routingOrder'] = 1
          new_recipient['tabs'] = [
              {
                  'type': 'signHere',
                  'anchorString': generate_anchor('signHere', item.email)
              },
          ]
          recipients.append(new_recipient)

  for item in counterparts:
      if item.email:
          new_recipient = dict()
          new_recipient['name'] = item.name.text
          new_recipient['email'] = item.email
          new_recipient['group'] = 'signers'
          new_recipient['routingOrder'] = 1
          new_recipient['tabs'] = [
              {
                  'type': 'signHere',
                  'anchorString': generate_anchor('signHere', item.email)
              },
          ]
          recipients.append(new_recipient)

  if has_extraparts:
      for item in extraparts:
          if item.email:
              new_recipient = dict()
              new_recipient['name'] = item.name.text
              new_recipient['email'] = item.email
              new_recipient['group'] = 'signers'
              new_recipient['routingOrder'] = 1
              new_recipient['tabs'] = [
                  {
                      'type': 'signHere',
                      'anchorString': generate_anchor('signHere', item.email)
                  },
              ]
              recipients.append(new_recipient)

  if has_witnesses:
        for item in witnesses:
            if item.email:
                new_recipient = dict()
                new_recipient['name'] = item.name.text
                new_recipient['email'] = item.email
                new_recipient['group'] = 'signers'
                new_recipient['routingOrder'] = 1
                new_recipient['tabs'] = [
                    {
                        'type': 'signHere',
                        'anchorString': generate_anchor('signHere', item.email)
                    },
                ]
                recipients.append(new_recipient)

---
ga id: |
  code: ga_id_end
event: document_ready_screen
section: Conclusão
progress: 100
back button: False
question: |
  Seu documento foi gerado com sucesso!

  - Generated file: ${ generated_file }

subquestion: |
  Nome do documento:
  ${ generated_file.filename }
action buttons:
  code: |
    button_list
---
code: |
  button_list = list()
  button_list.append(el_button)
---
code: |
  el_button = {'action': educalegal_url + '/document/document/' + doc_uuid,
                'label': 'Ver detalhes',
                'color': 'success',
                'icon': 'check'}
---
code: |
  import json

  log("generated_file", "console")
  log(generated_file, "console")

  log("import json", "console")

  # private=False - para que o arquivo fique acessivel fora do docassemble
  generated_file.set_attributes(private=False)

  log("generated_file", "console")
  log(generated_file, "console")

  # dados do documento que serao salvos no educa legal---
  data = {
     "name": custom_file_name + '.pdf',
     "description": interview_description,
     "status": "criado",
     "school": school_id,
     "document_type": interview_document_type_choice,
     "parent": None,
     "recipients": json.dumps(recipients),
     "document_data": json.dumps(all_variables())
  }

  log("dados data", "console")
  log(data, "console")

  # external=True - acrescenta na url o protocolo and hostname (https://hostname)
  params = {
      "trigger": "docassemble",
      "pdf_url": generated_file.url_for(external=True),
      "pdf_filename": custom_file_name + '.pdf',
      "tenant_id": tid,
      "doc_uuid": doc_uuid,
  }
  log("params:", "console")
  log(params, "console")

  # atualiza no educa legal dados do documento gerado
  status_code, el_patch_document = elc.patch_document(data, params)

  log("status_code:", "console")
  log(status_code, "console")

  log("el_patch_document:", "console")
  log(el_patch_document, "console")

  if status_code == 200:
    log("Atualizado o documento")
  else:
    log("Erro ao atualizar o documento")
  log("{doc_uuid} - {data}".format(doc_uuid=doc_uuid, data=el_patch_document))
